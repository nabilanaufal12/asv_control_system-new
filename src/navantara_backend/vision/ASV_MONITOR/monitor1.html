<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NAVANTARA - ASV Dashboard</title>
    <link rel="stylesheet" href="/css/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;800&family=Inter:wght@400;500;700;800&display=swap"
      rel="stylesheet"
    />
    <style>
      /* Menyembunyikan elemen yang tidak diperlukan lagi */
      .arena-selector,
      .button-container {
        display: none;
      }
      /* Mengatur tata letak header section agar rapi */
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }
      .path-title {
        margin-left: auto; /* Mendorong tulisan LINTASAN ke kanan */
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <header class="header">
        <div class="header-logos-left">
          <img src="/images/umrah.png" alt="UMRAH Logo" class="logo" />
          <img src="/images/src.png" alt="SRC Logo" class="logo" />
          </div>
        <div class="header-title">
          <h1>NAVANTARA</h1>
          <h2>Universitas Maritim Raja Ali Haji</h2>
        </div>
        <div class="header-logos">
          <img
            src="/images/logo-kompetisi.png"
            alt="Competition Logo"
            class="logo"
          />
          <img src="/images/logo-kki.png" alt="KKI Logo" class="logo" />
          <img src="/images/umm-logo.png" alt="UMM Logo" class="logo" />
          </div>
      </header>

      <main class="main-content">
        <div class="left-column">
          <section class="trajectory-section">
            <div class="section-header">
              <h3>TRAJECTORY</h3>
              <h3 class="path-title">
                LINTASAN : <span id="arena-display">A</span>
              </h3>
            </div>
            <div class="trajectory-map">
              <div class="trajectory-left">
                <div class="container">
                  <div class="arena-selector">
                    <button id="arena-a-btn">Arena A</button>
                    <button id="arena-b-btn">Arena B</button>
                  </div>

                  <div id="canvas-container">
                    <canvas
                      id="background-canvas"
                      width="800"
                      height="500"
                    ></canvas>
                    <canvas id="grid-canvas" width="800" height="500"></canvas>
                    <canvas id="line-canvas" width="800" height="500"></canvas>
                    <canvas
                      id="point-canvas"
                      width="800"
                      height="500"
                    ></canvas>
                  </div>

                  <div class="button-container">
                    <button id="next-btn">Next</button>
                  </div>
                </div>
              </div>
              <div class="trajectory-right">
                <div class="map-container">
                  <iframe
                    id="map-iframe"
                    class="map-iframe"
                    src="https://maps.google.com/maps?q=-6.2088,106.8456&hl=id&z=14&output=embed"
                    allowfullscreen=""
                    loading="lazy"
                  ></iframe>
                </div>
              </div>
            </div>
          </section>

          <section class="camera-section">
            <div class="camera-feed">
              <h3>CAM 1</h3>
              <div class="camera-container" id="cam1-container">
                </div>
            </div>
            <div class="camera-feed">
              <h3>CAM 2</h3>
              <div class="camera-container" id="cam2-container">
                </div>
            </div>
          </section>
        </div>
        <div class="right-column">
          <section class="info-section">
            <h3>Voyage Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <span>HDG:</span><span id="hdg-value">0°</span>
              </div>
              <div class="info-item">
                <span>SOG:</span><span id="sog-value">0 m/s</span>
              </div>
              <div class="info-item">
                <span>COG:</span><span id="cog-value">0°</span>
              </div>
              <div class="info-item">
                <span>DAY:</span><span id="day-value">...</span>
              </div>
              <div class="info-item">
                <span>DATE:</span><span id="date-value">...</span>
              </div>
              <div class="info-item">
                <span>GPS:</span><span id="gps-value">...</span>
              </div>
            </div>
          </section>
          <section class="capture-section">
            <h3>Hasil Capture</h3>
            <div class="capture-container">
              <div class="capture-column">
                <h4>Surface</h4>
                <div class="capture-grid" id="surface-captures">
                  </div>
              </div>
              <div class="capture-column">
                <h4>Underwater</h4>
                <div class="capture-grid" id="underwater-captures">
                  </div>
              </div>
            </div>
          </section>
        </div>
      </main>
    </div>

    <div class="modal" id="image-modal">
      <div class="modal-content">
        <img id="modal-img" src="" alt="Preview Image" />
        <div class="modal-actions">
          <a id="download-btn" href="" download
            ><button class="btn">Download</button></a
          >
          <button id="close-modal" class="btn btn-secondary">Tutup</button>
        </div>
      </div>
    </div>

    <script src="/js/firebase.js"></script>
    <script src="/js/supabase.js"></script>
    <script src="/js/main.js"></script>
    <script>
      // Logika JavaScript untuk canvas trajektori (tidak berubah)
      document.addEventListener("DOMContentLoaded", function () {
        const backgroundCtx = document.getElementById("background-canvas").getContext("2d");
        const gridCtx = document.getElementById("grid-canvas").getContext("2d");
        const lineCtx = document.getElementById("line-canvas").getContext("2d");
        const pointCtx = document.getElementById("point-canvas").getContext("2d");
        const arenaABtn = document.getElementById("arena-a-btn");
        const arenaBBtn = document.getElementById("arena-b-btn");
        const arenaDisplay = document.getElementById("arena-display");
        const pointsData = {
          A: [ { x: 680, y: 448 }, { x: 632, y: 251 }, { x: 692, y: 90 }, { x: 400, y: 90 }, { x: 177, y: 92 }, { x: 140, y: 256 }, { x: 167, y: 431 }, { x: 312, y: 407 }, { x: 628, y: 450 }, ],
          B: [ { x: 115, y: 449 }, { x: 165, y: 252 }, { x: 120, y: 94 }, { x: 408, y: 91 }, { x: 650, y: 86 }, { x: 659, y: 251 }, { x: 617, y: 425 }, { x: 480, y: 409 }, { x: 156, y: 451 }, ],
        };
        let currentArena = null;
        let predefinedPoints = [];
        let points = [];

        function switchArena(arena) {
          if (currentArena === arena || !pointsData[arena]) return;
          currentArena = arena;
          predefinedPoints = pointsData[arena];
          arenaDisplay.textContent = arena;
          // Tidak perlu update tombol A/B karena disembunyikan
          initialize();
        }

        window.addEventListener("switchArena", (event) => switchArena(event.detail.arena));

        function drawUpToPoint(pointNumber) {
          const maxPoints = predefinedPoints.length;
          // Pastikan pointNumber valid, jika tidak, gambar semua titik sampai index tersebut
          const targetPointIndex = Math.max(0, Math.min(pointNumber, maxPoints));
          points = [];
          for (let i = 0; i < targetPointIndex; i++) {
            points.push(predefinedPoints[i]);
          }
          drawAll();
        }


        window.addEventListener("setTrajectoryPoint", function (event) {
          const pointIndex = parseInt(event.detail.point, 10);
          if (!isNaN(pointIndex)) {
             // pointIndex dari firebase dimulai dari 1, sedangkan array JS dari 0
             // Jadi jika pointIndex 1, kita gambar sampai titik ke-1 (index 0)
             drawUpToPoint(pointIndex);
          } else {
             drawUpToPoint(0); // Gambar kosong jika point tidak valid
          }
        });

        function initialize() {
          drawBackground();
          drawGrid();
          drawUpToPoint(lastKnownPoint); // Gunakan point terakhir yang diketahui
        }

        function drawBackground() {
          backgroundCtx.clearRect(0, 0, 800, 500);
          backgroundCtx.fillStyle = "#FFFFFF";
          backgroundCtx.fillRect(0, 0, 800, 500);
          const img = new Image();
          img.onload = () => backgroundCtx.drawImage(img, 0, 0, 800, 500);
          img.onerror = () => {
            backgroundCtx.fillStyle = "#f0f8ff"; // Warna fallback
            backgroundCtx.fillRect(0, 0, 800, 500);
            backgroundCtx.fillStyle = "#3498db";
            backgroundCtx.font = "bold 24px Arial";
            backgroundCtx.textAlign = "center";
            // Tampilkan arena saat ini jika gambar gagal dimuat
            backgroundCtx.fillText(`ARENA ${currentArena || '?'}`, 400, 250);
          };
          // MODIFIKASI PATH IMAGE
          img.src = `/images/Arena_${currentArena || 'A'}.png`; // Default ke A jika belum ada
          // AKHIR MODIFIKASI
        }

        function drawGrid() {
          gridCtx.clearRect(0, 0, 800, 500);
          gridCtx.strokeStyle = "#e0e0e0"; // Warna grid lebih terang
          gridCtx.lineWidth = 1;
          for (let x = 50; x < 800; x += 50) { gridCtx.beginPath(); gridCtx.moveTo(x, 0); gridCtx.lineTo(x, 500); gridCtx.stroke(); }
          for (let y = 50; y < 500; y += 50) { gridCtx.beginPath(); gridCtx.moveTo(0, y); gridCtx.lineTo(800, y); gridCtx.stroke(); }
          // Optional: Hapus border tebal jika tidak diperlukan
          // gridCtx.strokeStyle = "#bdc3c7";
          // gridCtx.lineWidth = 2;
          // gridCtx.strokeRect(0, 0, 800, 500);
        }

        function drawPoint(x, y, index) {
          pointCtx.fillStyle = "#8e44ad"; // Warna titik ungu
          pointCtx.beginPath();
          pointCtx.arc(x, y, 6, 0, Math.PI * 2); // Ukuran titik sedikit lebih kecil
          pointCtx.fill();
          pointCtx.strokeStyle = "#ffffff"; // Outline putih
          pointCtx.lineWidth = 1.5;
          pointCtx.stroke();
          // Optional: Sembunyikan nomor titik jika terlalu ramai
           pointCtx.fillStyle = "#2c3e50"; // Warna teks nomor
           pointCtx.font = "bold 12px Arial"; // Ukuran font nomor
           pointCtx.textAlign = "center";
           pointCtx.fillText((index + 1).toString(), x, y - 15); // Posisi nomor di atas titik
        }

        function drawLine(x1, y1, x2, y2) {
          lineCtx.strokeStyle = "#FFA500"; // Warna garis oranye
          lineCtx.lineWidth = 2.5;         // Ketebalan garis
          lineCtx.setLineDash([8, 4]);    // Pola garis putus-putus
          lineCtx.beginPath();
          lineCtx.moveTo(x1, y1);
          lineCtx.lineTo(x2, y2);
          lineCtx.stroke();
          lineCtx.setLineDash([]); // Reset pola garis
        }

        function drawAll() {
          lineCtx.clearRect(0, 0, 800, 500);
          pointCtx.clearRect(0, 0, 800, 500);
          for (let i = 0; i < points.length; i++) {
            drawPoint(points[i].x, points[i].y, i);
            if (i > 0) {
              drawLine(points[i - 1].x, points[i - 1].y, points[i].x, points[i].y);
            }
          }
        }

        // Inisialisasi dengan arena default (misal 'A') jika belum ada data dari Firebase
        switchArena(lastKnownArena || "A");

      });
    </script>
  </body>
</html>