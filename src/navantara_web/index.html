<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>NAVANTARA - ASV Dashboard (LOKAL - SSE)</title>
    <link rel="stylesheet" href="css/styles.css" />
    <link
      href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;700;800&family=Inter:wght@400;500;700;800&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="lib/leaflet/leaflet.css" />
    <style>
      /* ... (Semua CSS Anda yang ada tetap di sini, tidak berubah) ... */

      .arena-selector,
      .button-container {
        display: none;
      }
      .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
      }
      .path-title {
        margin-left: auto;
      }

      .camera-container img {
        width: 100%;
        height: auto;
        max-height: 280px;
        object-fit: cover;
        border-radius: 8px;
        background-color: #2c3e50;
      }

      #map-canvas {
        width: 100%;
        height: 100%;
        border-radius: 8px;
        background-color: #e0e0e0;
      }

      .leaflet-control-attribution {
        display: none !important;
      }

      .capture-section .section-header {
        margin-bottom: 10px;
      }
      #refresh-gallery-btn {
        padding: 5px 10px;
        font-size: 0.8rem;
        cursor: pointer;
        background-color: #3498db;
        color: white;
        border: none;
        border-radius: 4px;
      }
      #refresh-gallery-btn:hover {
        background-color: #2980b9;
      }

      .capture-grid {
        max-height: 200px;
        overflow-y: auto;
        background-color: #ecf0f1;
        border-radius: 5px;
        padding: 10px;
        box-sizing: border-box;
      }
      .capture-grid p {
        color: #7f8c8d;
        text-align: center;
        margin: 0;
      }
      .capture-grid img {
        width: 100%;
        margin-bottom: 8px;
        border-radius: 4px;
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div class="dashboard">
      <header class="header">
        <div class="header-logos-left">
          <img src="images/umrah.png" alt="UMRAH Logo" class="logo" />
          <img src="images/src.png" alt="SRC Logo" class="logo" />
        </div>
        <div class="header-title">
          <h1>NAVANTARA</h1>
          <h2>Universitas Maritim Raja Ali Haji</h2>
        </div>
        <div class="header-logos">
          <img
            src="images/logo-kompetisi.png"
            alt="Competition Logo"
            class="logo"
          />
          <img src="images/logo-kki.png" alt="KKI Logo" class="logo" />
          <img src="images/umm-logo.png" alt="UMM Logo" class="logo" />
        </div>
      </header>

      <main class="main-content">
        <div class="left-column">
          <section class="trajectory-section">
            <div class="section-header">
              <h3>TRAJECTORY</h3>
              <h3 class="path-title">
                LINTASAN : <span id="arena-display">A</span>
              </h3>
            </div>
            <div class="trajectory-map">
              <div class="trajectory-left">
                <div class="container">
                  <div class="arena-selector">
                    <button id="arena-a-btn">Arena A</button>
                    <button id="arena-b-btn">Arena B</button>
                  </div>
                  <div id="canvas-container">
                    <canvas
                      id="background-canvas"
                      width="800"
                      height="500"
                    ></canvas>
                    <canvas id="grid-canvas" width="800" height="500"></canvas>
                    <canvas id="line-canvas" width="800" height="500"></canvas>
                    <canvas id="point-canvas" width="800" height="500"></canvas>
                  </div>
                  <div class="button-container">
                    <button id="next-btn">Next</button>
                  </div>
                </div>
              </div>
              <div class="trajectory-right">
                <div class="map-container">
                  <div id="map-canvas" class="map-iframe"></div>
                </div>
              </div>
            </div>
          </section>

          <section class="camera-section">
            <div class="camera-feed">
              <h3>SURFACE CAM</h3>
              <div class="camera-container" id="cam1-container">
                <img
                  src="http://192.168.1.14:5000/live_video_feed"
                  alt="Camera 1 Feed"
                  crossorigin="anonymous"
                />
              </div>
            </div>
            <div class="camera-feed">
              <h3>UNDERWATER CAM</h3>
              <div class="camera-container" id="cam2-container">
                <img
                  src="http://192.168.1.14:5000/live_video_feed_cam2"
                  alt="Camera 2 Feed"
                  crossorigin="anonymous"
                />
              </div>
            </div>
          </section>
        </div>
        <div class="right-column">
          <section class="info-section">
            <h3>Voyage Information</h3>
            <div class="info-grid">
              <div class="info-item">
                <span>DAY:</span><span id="day-value">...</span>
              </div>
              <div class="info-item">
                <span>DATE:</span><span id="date-value">...</span>
              </div>
              <div class="info-item">
                <span>TIME:</span><span id="time-value">...</span>
              </div>
              <div class="info-item">
                <span>GPS:</span><span id="gps-value">Connecting...</span>
              </div>
              <div class="info-item">
                <span>SOG:</span><span id="sog-value">0 km/jam</span>
              </div>
              <div class="info-item">
                <span>COG:</span><span id="cog-value">0Â°</span>
              </div>
              <div class="info-item">
                <span>HDG:</span><span id="hdg-value">0Â°</span>
              </div>
            </div>

            </section> 
            
            <section class="capture-section">
              <div class="section-header">
                <h3>Capture Results</h3>
                <button id="refresh-gallery-btn">Refresh Gallery</button>
              </div>

              <div class="capture-results">
                
                <div class="gallery-column">
                  <h4>Surface</h4>
                  <div class="capture-grid" id="surface-gallery">
                    <p>Klik 'Refresh Gallery' untuk memuat gambar...</p>
                  </div>
                </div>

                <div class="gallery-column">
                  <h4>Underwater</h4>
                  <div class="capture-grid" id="underwater-gallery">
                    <p>Klik 'Refresh Gallery' untuk memuat gambar...</p>
                  </div>
                </div>
              
                <div class="wave-container">
                  <div class="wave"></div>
                  <div class="wave"></div>
                </div>
              </div>

            </section>
            </div>
      </main>
    </div>

    <div class="modal" id="image-modal">
      <div class="modal-content">
        <img id="modal-img" src="" alt="Preview Image" />
        <div class="modal-actions">
          <a id="download-btn" href="" download
            ><button class="btn">Download</button></a
          >
          <button id="close-modal" class="btn btn-secondary">Tutup</button>
        </div>
      </div>
    </div>
    <script src="js/supabase.js"></script>

    <script src="lib/leaflet/leaflet.js"></script>
    <script src="js/main.js"></script>

    <script>
      document.addEventListener("DOMContentLoaded", function () {
        const backgroundCtx = document
          .getElementById("background-canvas")
          ?.getContext("2d");
        const gridCtx = document.getElementById("grid-canvas")?.getContext("2d");
        const lineCtx = document.getElementById("line-canvas")?.getContext("2d");
        const pointCtx = document
          .getElementById("point-canvas")
          ?.getContext("2d");
        const arenaABtn = document.getElementById("arena-a-btn");
        const arenaBBtn = document.getElementById("arena-b-btn");
        const arenaDisplay = document.getElementById("arena-display");

        // Periksa apakah canvas ada sebelum melanjutkan
        if (
          !backgroundCtx ||
          !gridCtx ||
          !lineCtx ||
          !pointCtx ||
          !arenaDisplay
        ) {
          console.warn(
            "Salah satu elemen canvas atau arenaDisplay tidak ditemukan."
          );
          return;
        }

        const pointsData = {
          A: [
            { x: 680, y: 448 },
            { x: 632, y: 251 },
            { x: 692, y: 90 },
            { x: 400, y: 90 },
            { x: 177, y: 92 },
            { x: 140, y: 256 },
            { x: 167, y: 431 },
            { x: 312, y: 407 },
            { x: 628, y: 450 },
          ],
          B: [
            { x: 115, y: 449 },
            { x: 165, y: 252 },
            { x: 120, y: 94 },
            { x: 408, y: 91 },
            { x: 650, y: 86 },
            { x: 659, y: 251 },
            { x: 617, y: 425 },
            { x: 480, y: 409 },
            { x: 156, y: 451 },
          ],
        };
        let currentArena = null;
        let predefinedPoints = [];
        let points = [];

        function switchArena(arena) {
          // ðŸš© PERBAIKAN: Izinkan switch meskipun pointsData[arena] tidak ada (misal: 'Unknown')
          if (currentArena === arena) return; 
          
          currentArena = arena;
          
          // Gunakan data jika ada, jika tidak, array kosong
          predefinedPoints = pointsData[arena] || []; 
          
          arenaDisplay.textContent = arena;
          if (arenaABtn && arenaBBtn) {
            // Cek tombol arena
            if (arena === "A") {
              arenaABtn.classList.add("active");
              arenaBBtn.classList.remove("active");
            } else {
              arenaBBtn.classList.add("active");
              arenaABtn.classList.remove("active");
            }
          }
          initialize(); // Pastikan initialize selalu dipanggil
        }

        window.addEventListener("switchArena", (event) =>
          switchArena(event.detail.arena)
        );

        function drawUpToPoint(pointNumber) {
          const maxPoints = predefinedPoints.length;
          const targetPoint = Math.max(0, Math.min(pointNumber, maxPoints));
          points = [];
          for (let i = 0; i < targetPoint; i++) {
            points.push(predefinedPoints[i]);
          }
          drawAll();
        }

        window.addEventListener("setTrajectoryPoint", function (event) {
          const pointIndex = parseInt(event.detail.point, 10);
          
          // ðŸš© LOG PENERIMAAN EVENT DARI JS/MAIN.JS
          console.log("[Canvas Script] Event 'setTrajectoryPoint' diterima. Titik target:", pointIndex);
          
          if (!isNaN(pointIndex)) {
            drawUpToPoint(pointIndex);
          }
        });

        function initialize() {
          drawBackground();
          drawGrid();
          // PERBAIKAN: Set awal ke 0 titik, menunggu perintah dari telemetri
          drawUpToPoint(0); 
        }

        function drawBackground() {
          backgroundCtx.clearRect(0, 0, 800, 500);
          backgroundCtx.fillStyle = "#FFFFFF";
          backgroundCtx.fillRect(0, 0, 800, 500);
          const img = new Image();
          img.onload = () => backgroundCtx.drawImage(img, 0, 0, 800, 500);
          img.onerror = () => {
            backgroundCtx.fillStyle = "#f0f8ff";
            backgroundCtx.fillRect(0, 0, 800, 500);
            backgroundCtx.fillStyle = "#3498db";
            backgroundCtx.font = "bold 24px Arial";
            backgroundCtx.textAlign = "center";
            backgroundCtx.fillText(`ARENA ${currentArena || "?"}`, 400, 250);
          };
          img.src = `images/Arena_${currentArena}.png`; // Diubah agar dinamis
        }

        function drawGrid() {
          gridCtx.clearRect(0, 0, 800, 500);
          gridCtx.strokeStyle = "#e0e0e0";
          gridCtx.lineWidth = 1;
          for (let x = 50; x < 800; x += 50) {
            gridCtx.beginPath();
            gridCtx.moveTo(x, 0);
            gridCtx.lineTo(x, 500);
            gridCtx.stroke();
          }
          for (let y = 50; y < 500; y += 50) {
            gridCtx.beginPath();
            gridCtx.moveTo(0, y);
            gridCtx.lineTo(800, y);
            gridCtx.stroke();
          }
          gridCtx.strokeStyle = "#bdc3c7";
          gridCtx.lineWidth = 2;
          gridCtx.strokeRect(0, 0, 800, 500);
        }

        function drawPoint(x, y, index) {
          pointCtx.fillStyle = "#8e44ad";
          pointCtx.beginPath();
          pointCtx.arc(x, y, 8, 0, Math.PI * 2);
          pointCtx.fill();
          pointCtx.strokeStyle = "#ffffff";
          pointCtx.lineWidth = 2;
          pointCtx.stroke();
          pointCtx.fillStyle = "#2c3e50";
          pointCtx.font = "bold 16px Arial";
          pointCtx.textAlign = "center";
          pointCtx.fillText((index + 1).toString(), x, y - 25);
        }

        function drawLine(x1, y1, x2, y2) {
          lineCtx.strokeStyle = "#FFA500";
          lineCtx.lineWidth = 3;
          lineCtx.setLineDash([10, 5]);
          lineCtx.beginPath();
          lineCtx.moveTo(x1, y1);
          lineCtx.lineTo(x2, y2);
          lineCtx.stroke();
          lineCtx.setLineDash([]);
        }

        function drawAll() {
          lineCtx.clearRect(0, 0, 800, 500);
          pointCtx.clearRect(0, 0, 800, 500);
          for (let i = 0; i < points.length; i++) {
            drawPoint(points[i].x, points[i].y, i);
            if (i > 0) {
              drawLine(
                points[i - 1].x,
                points[i - 1].y,
                points[i].x,
                points[i].y
              );
            }
          }
        }

        switchArena("A"); // Mulai dengan Arena A
      });
    </script>
  </body>
</html>